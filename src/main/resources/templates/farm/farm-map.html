<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>í…ƒë°­ ì§€ë„ í™”ë©´</title>
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <style>
        #map {
            width: 500px;
            height: 500px;
        }
    </style>
    <script th:src="'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoApiKey} + '&autoload=false'"></script>
</head>
<body th:replace="~{layout::layout}">
<div th:fragment="content">
    <h1>ğŸ—ºï¸ ì¹´ì¹´ì˜¤ ì§€ë„</h1>
    <div id="map"></div>
    <script>
        // ì§€ë„ë¥¼ ë‹´ì„ ì˜ì—­ì˜ DOM ë ˆí¼ëŸ°ìŠ¤
        var mapContainer = document.getElementById('map');

        // ì§€ë„ ìƒì„± ì‹œ í•„ìš”í•œ ê¸°ë³¸ ì˜µì…˜
        var mapOptions = {
            // ì§€ë„ì˜ ì¤‘ì‹¬ ì¢Œí‘œ (ë°˜ë“œì‹œ í•„ìš”)
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ìœ„ì¹˜
            level: 3 // ì§€ë„ì˜ ë ˆë²¨ (í™•ëŒ€, ì¶•ì†Œ ì •ë„)
        };

        // ì§€ë„ ìƒì„±
        var map = new kakao.maps.Map(mapContainer, mapOptions);

        var imageSrc = 'https://aws-bucket-farming-family-25078.s3.ap-northeast-2.amazonaws.com/farmMarker.png';
        var imageSize = new kakao.maps.Size(64, 69);
        var imageOption = {offset: new kakao.maps.Point(27, 69)};
        // ë§ˆì»¤ì˜ ì¢Œí‘œì™€ ì¼ì¹˜ì‹œí‚¬ ì´ë¯¸ì§€ ì•ˆì—ì„œì˜ ì¢Œí‘œë¥¼ ì„¤ì •

        // ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

        // í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ í…ƒë°­ ì •ë³´ ì¡°íšŒ (ë§ˆì»¤, ì¸í¬ìœˆë„ìš° ìƒì„±)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(onSuccessGeolocation, function(error) {
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            });
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ê³ , ì£¼ë³€ í…ƒë°­ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™€ì„œ ë§ˆì»¤ì™€ ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function onSuccessGeolocation(position) {
            const lat = position.coords.latitude; // ìœ„ë„
            const lng = position.coords.longitude; // ê²½ë„
            let radius = 20; // ë°˜ê²½

            // í˜„ì¬ ìœ„ì¹˜
            var currentPosition = new kakao.maps.LatLng(lat, lng);

            // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
            var marker = new kakao.maps.Marker({
                map: map,
                position: currentPosition
            });

            // í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
            map.setCenter(currentPosition);

            // ì£¼ë³€ í…ƒë°­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            fetch(`http://localhost:8080/api/farms/nearby?latitude=${lat}&longitude=${lng}&radius=${radius}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                console.log('í…ƒë°­ ëª©ë¡:', data);
                // ì£¼ë³€ í…ƒë°­ ë§ˆì»¤ì™€ ì¸í¬ìœˆë„ìš° ìƒì„±
                showFarms(data);
            })
            .catch(err => {
                console.error('ì—ëŸ¬:', err);
            });
        }

        // ì£¼ë³€ í…ƒë°­ì˜ ë§ˆì»¤ì™€ ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function showFarms(data) {
            data.forEach(farm => {
                const { farmId, gardenUniqueId, operator, farmName,
                        roadNameAddress, lotNumberAddress,
                        facilities, contact, latitude, longitude,
                        available, createdAt, updatedAt, farmImageUrl } = farm;

                // í…ƒë°­ ìœ„ì¹˜
                var farmPosition = new kakao.maps.LatLng(latitude, longitude);

                // í…ƒë°­ ë§ˆì»¤ ìƒì„±
                var farmMarker = new kakao.maps.Marker({
                    map: map,
                    position: farmPosition,
                    image: markerImage,
                    clickable: true
                });
                // clickable: ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì§€ë„ì˜ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì„¤ì •

                var iwContent = `<div style="padding:5px;font-size:14px;">
                    ${farmId}<br />
                    ${gardenUniqueId}<br />
                    ${operator}<br />
                    ${farmName}<br />
                    ${roadNameAddress}<br />
                    ${lotNumberAddress}<br />
                    ${facilities}<br />
                    ${contact}<br />
                    ${available}<br />
                    ${createdAt}<br />
                    ${updatedAt}<br />
                    ${farmImageUrl}
                    </div>`

                // ì¸í¬ìœˆë„ìš° ìƒì„±
                var infoWindow = new kakao.maps.InfoWindow({
                    //position: farmPosition,
                    content: iwContent,
                    removable : true
                });
                // removable: tureë¡œ ì„¤ì •í•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ë‹«ì„ ìˆ˜ ìˆëŠ” xë²„íŠ¼ í‘œì‹œ

                // ë§ˆì»¤ í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš° í‘œì‹œ
                kakao.maps.event.addListener(farmMarker, 'click', function() {
                    infoWindow.open(map, farmMarker);
                    //if (infoWindow.getMap()) {
                    //    infoWindow.close();
                    //}
                    //else {
                    //    infoWindow.open(map, marker);
                    //}
                });
            });
        }
    </script>
</div>
</body>
</html>